!function($){var e={init:function(e,t){return this.options=$.extend({},this.options,e),this.elem=t,this.$elem=$(t),this._markers=[],this._build(),this},options:{address:"",lat:44.509234,lng:-173.559067,width:500,height:500,zoom:15,mapType:google.maps.MapTypeId.ROADMAP,placeMainMarker:!0,mainMarkerIcon:"",markers:[],placesTypes:[],placesTypesIcon:[],excludePlacesTypes:[],excludeByKeywords:[],placesRadius:500,disableDefaultUI:!1,style:[],draggable:!0,scrollwheel:!0,backgroundColor:"#000000",markercluster:!1,markerclusterStyles:[],markerclusterOptions:{},centerOffsetX:0,centerOffsetY:0,useInfoBox:!1,infoBoxOptions:{}},_markup:"<div class='infowindow-markup'><strong>{{name}} </strong>{{vicinity}}</div>",_build:function(){var e=this.options;$(this.elem).width(e.width).height(e.height),google.maps.visualRefresh=!0,$(this.elem).attr("data-address")&&(e.address=$(this.elem).attr("data-address")),""!=$(this.elem).html()&&(this._markup=$(this.elem).html(),$(this.elem).html("")),""==e.address?this._setupMap(e.lat,e.lng):this._geocodeAddress(e.address),$("head").append("<style>#"+$(this.elem).attr("id")+" * { max-width:none; }</style>")},_geocodeAddress:function(e){var t=new google.maps.Geocoder;t.geocode({address:e},this._locationFound.bind(this))},_locationFound:function(e,t){"OK"==t?this._setupMap(e[0].geometry.location.lat(),e[0].geometry.location.lng()):console.log("An error occured while geocoding the address.")},_setupMap:function(e,t){var s=this.options,o={zoom:s.zoom,mapTypeId:this.options.mapType,center:new google.maps.LatLng(e,t),disableDefaultUI:this.options.disableDefaultUI,backgroundColor:this.options.backgroundColor,scrollwheel:this.options.scrollwheel,draggable:this.options.draggable};this.map=new google.maps.Map(this.elem,o),this.map.addListener("bounds_changed",function(){this._offsetCenter(o.center,this.options.centerOffsetX,this.options.centerOffsetY),google.maps.event.clearListeners(this.map,"bounds_changed")}.bind(this)),this.map.set("styles",this.options.style),s.placeMainMarker&&this._placeMainMarker(e,t),s.placesTypes.length>0&&this._searchPlaces(e,t),s.markers&&s.markers.length>0&&s.markers.forEach(this._createCustomMarker.bind(this)),this.options.markercluster&&MarkerClusterer&&(this._markerCluster=new MarkerClusterer(this.map,this._markers,this.options.markerclusterOptions),this._markerCluster.setStyles(this.options.markerclusterStyles))},_createCustomMarker:function(e){var t={};t.map=this.map,t.position=e.location,t.icon=e.icon,this.infoWindow=this.infoWindow||(this.options.useInfoBox?new InfoBox(this.options.infoBoxOptions):new google.maps.InfoWindow);var s=new google.maps.Marker(t),o=function(e){this.infoWindow.setContent(e),this.infoWindow.open(this.map,s)}.bind(this);google.maps.event.addListener(s,"click",function(){e.getInfoWindowMarkup.call(e,o)}),this._markers.push(s)},_placeMainMarker:function(e,t){var s={};s.map=this.map,s.draggable=!1,s.animation=google.maps.Animation.DROP,s.position=new google.maps.LatLng(e,t),""!=this.options.mainMarkerIcon&&(s.icon=this.options.mainMarkerIcon),this.mainMarker&&this.mainMarker.setMap(null),this.mainMarker=new google.maps.Marker(s)},moveMainMarker:function(e,t,s,o){this.options.placeMainMarker=s,this._placeMainMarker(e,t),this.map.setZoom(o),this._offsetCenter(this.mainMarker.position,this.options.centerOffsetX,this.options.centerOffsetY)},_searchPlaces:function(e,t){req={},req.location=new google.maps.LatLng(e,t),req.radius=this.options.placesRadius,req.types=this.options.placesTypes,this.infoWindow=new google.maps.InfoWindow;var s=new google.maps.places.PlacesService(this.map);s.nearbySearch(req,this._placesCallback.bind(this))},_placesCallback:function(e,t){if(t==google.maps.places.PlacesServiceStatus.OK)for(var s=0;s<e.length;s++)this._createPlaceMarker(e[s])},_createPlaceMarker:function(e){for(var t=!1,s=this._getType(e.types),o=0;o<this.options.excludePlacesTypes.length;o++)for(var i=0;i<e.types.length;i++)this.options.excludePlacesTypes[o]==e.types[i]&&(t=!0);for(o=0;o<this.options.excludeByKeywords.length;o++)e.name.toLowerCase().indexOf(this.options.excludeByKeywords[o].toLowerCase())>=0&&(t=!0);if(!t){var n=e.geometry.location,a={};a.map=this.map,a.position=n,this.options.placesTypesIcon.length>0&&(a.icon=this.options.placesTypesIcon[s]);var r=new google.maps.Marker(a);r.place=this._parseMarkup(e),google.maps.event.addListener(r,"click",function(){this.infoWindow.setContent(r.place),this.infoWindow.open(this.map,r)}.bind(this))}this._markers.push(r)},_parseMarkup:function(e){return this._markup.replace(/{{([^}]+)}}/g,function(t,s,o,i){for(var n=s.split("."),a=n.length,r=e,p=0;a>p&&(r=r[n[p]],r);p++);return r?r:""})},_getType:function(e){for(var t=-1,s=0;s<e.length;s++)if(-1!=this.options.placesTypes.indexOf(e[s])){t=this.options.placesTypes.indexOf(e[s]);break}return t},resize:function(){google.maps.event.trigger(this.map,"resize")},_offsetCenter:function(e,t,s){var o=Math.pow(2,this.map.getZoom()),i=new google.maps.LatLng(this.map.getBounds().getNorthEast().lat(),this.map.getBounds().getSouthWest().lng()),n=this.map.getProjection().fromLatLngToPoint(e),a=new google.maps.Point(t/o||0,s/o||0),r=new google.maps.Point(n.x-a.x,n.y+a.y),p=this.map.getProjection().fromPointToLatLng(r);this.map.setCenter(p)}};$.fn.whatsnearby=function(t){return this.length?this.each(function(){var s=Object.create(e);s.init(t,this),$.data(this,"whatsnearby",s)}):void 0}}(jQuery);